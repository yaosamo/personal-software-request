<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Request Board</title>
    <style>
      @font-face {
        font-family: "Departure Mono";
        src:
          url("https://departuremono.com/assets/DepartureMono-Regular.woff2") format("woff2"),
          url("https://departuremono.com/assets/DepartureMono-Regular.woff") format("woff");
        font-display: swap;
      }

      :root {
        --bg: #0b0b0c;
        --fg: #f2f2f2;
        --muted: #bdbdbd;
        --line: rgba(242, 242, 242, 0.22);
        --hair: rgba(242, 242, 242, 0.14);
        --disabled: rgba(242, 242, 242, 0.45);
        --track-1: 0.12em;
        --track-2: 0.18em;
        --track-3: 0.07em;
      }

      * {
        box-sizing: border-box;
        border-radius: 0;
      }

      body {
        margin: 0;
        background: var(--bg);
        color: var(--fg);
        text-transform: uppercase;
        font-family: "Departure Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-variant-numeric: tabular-nums;
        letter-spacing: var(--track-3);
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        opacity: 0.04;
        background-image: radial-gradient(circle at 1px 1px, #ffffff 1px, transparent 0);
        background-size: 8px 8px;
      }

      main {
        max-width: 840px;
        margin: 48px auto 64px;
        padding: 0 16px;
      }

      .sheet {
        border: 1px solid var(--line);
      }

      .section {
        padding: 24px 16px;
      }

      .section + .section {
        border-top: 1px solid var(--hair);
      }

      h1,
      h2 {
        margin: 0;
        letter-spacing: var(--track-1);
        font-weight: 800;
      }

      h1 {
        font-size: 28px;
      }

      h2 {
        font-size: 16px;
      }

      .subtitle {
        margin: 12px 0 0;
        color: var(--muted);
        letter-spacing: var(--track-2);
        font-size: 12px;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        border-top: 1px solid var(--hair);
      }

      .grid > .pane {
        padding: 24px 16px;
      }

      .grid > .pane + .pane {
        border-left: 1px solid var(--hair);
      }

      form {
        display: grid;
        gap: 16px;
      }

      .field {
        display: grid;
        gap: 8px;
      }

      label {
        color: var(--muted);
        letter-spacing: var(--track-2);
        font-weight: 600;
        font-size: 11px;
      }

      input,
      textarea,
      button {
        width: 100%;
        font: inherit;
        text-transform: uppercase;
        letter-spacing: var(--track-3);
      }

      input,
      textarea {
        border: 1px solid var(--line);
        background: transparent;
        color: var(--fg);
        padding: 12px;
        font-size: 13px;
        font-weight: 500;
      }

      input::placeholder,
      textarea::placeholder {
        color: var(--disabled);
      }

      input:focus,
      textarea:focus {
        outline: none;
        border-color: var(--fg);
      }

      textarea {
        min-height: 128px;
        resize: vertical;
      }

      button {
        border: 1px solid var(--fg);
        background: transparent;
        color: var(--fg);
        padding: 12px 16px;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: var(--track-2);
        cursor: pointer;
        transition: background-color 120ms ease, color 120ms ease, opacity 120ms ease;
      }

      button:hover {
        background: var(--fg);
        color: var(--bg);
      }

      button:active {
        opacity: 0.85;
      }

      button:disabled {
        border-color: var(--disabled);
        color: var(--disabled);
        cursor: wait;
      }

      .status {
        min-height: 16px;
        font-size: 11px;
        letter-spacing: var(--track-2);
      }

      .ok {
        color: var(--fg);
      }

      .err {
        color: #f0b3b3;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        letter-spacing: var(--track-3);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }

      .table th,
      .table td {
        border: 1px solid var(--hair);
        padding: 8px;
        vertical-align: top;
      }

      .table th {
        color: var(--muted);
        font-weight: 600;
        letter-spacing: var(--track-2);
        text-align: left;
      }

      .table td:last-child,
      .table th:last-child {
        text-align: right;
      }

      .table a {
        color: var(--fg);
        text-decoration: none;
        border-bottom: 1px solid var(--line);
      }

      .table a:hover {
        border-bottom-color: var(--fg);
      }

      .controls {
        margin-top: 16px;
        border: 1px solid var(--hair);
        padding: 8px;
      }

      .controls h3 {
        margin: 0 0 8px;
        font-size: 11px;
        letter-spacing: var(--track-2);
        color: var(--muted);
      }

      .control-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .control-grid .field {
        gap: 4px;
      }

      .control-grid label {
        font-size: 10px;
      }

      .control-grid input {
        padding: 8px;
        font-size: 11px;
      }

      .control-actions {
        margin-top: 8px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .toggle-row {
        margin-top: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .toggle-row label {
        margin: 0;
      }

      .toggle-row input[type="checkbox"] {
        width: 16px;
        height: 16px;
      }

      .meta {
        text-align: center;
        color: var(--muted);
        letter-spacing: var(--track-2);
        font-size: 11px;
      }

      @media (max-width: 800px) {
        .grid {
          grid-template-columns: 1fr;
        }

        .grid > .pane + .pane {
          border-left: none;
          border-top: 1px solid var(--hair);
        }

        h1 {
          font-size: 24px;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <section class="sheet">
        <section class="section">
          <h1>Request Personal Software</h1>
          <p class="subtitle">Submit a build request and receive email notification when delivered.</p>
        </section>

        <section class="grid">
          <section class="pane">
            <h2>New Request</h2>
            <form id="request-form">
              <div class="field">
                <label for="memo">Description</label>
                <textarea id="memo" name="memo" maxlength="5000" placeholder="Describe software request" required></textarea>
              </div>

              <div class="field">
                <label for="email">Email</label>
                <input id="email" name="email" type="email" maxlength="320" placeholder="name@example.com" required />
              </div>

              <button id="submit-btn" type="submit">Submit Request</button>
              <div id="status" class="status" aria-live="polite"></div>
            </form>

            <section class="controls">
              <h3>Animation Controls (Test)</h3>
              <div class="control-grid">
                <div class="field">
                  <label for="ctrl-sweep">Sweep ms (top to bottom)</label>
                  <input id="ctrl-sweep" type="number" min="200" max="15000" step="100" value="1000" />
                </div>
                <div class="field">
                  <label for="ctrl-spin">Spin ms per char</label>
                  <input id="ctrl-spin" type="number" min="200" max="15000" step="100" value="2000" />
                </div>
                <div class="field">
                  <label for="ctrl-stagger">Char stagger ms</label>
                  <input id="ctrl-stagger" type="number" min="1" max="500" step="1" value="80" />
                </div>
                <div class="field">
                  <label for="ctrl-tick">Tick ms</label>
                  <input id="ctrl-tick" type="number" min="16" max="500" step="1" value="20" />
                </div>
              </div>

              <div class="toggle-row">
                <input id="ctrl-submit-trigger" type="checkbox" checked />
                <label for="ctrl-submit-trigger">Trigger on submit</label>
              </div>

              <div class="control-actions">
                <button id="run-wave-test-btn" type="button">Run Animation Test</button>
                <button id="reset-wave-btn" type="button">Reset Defaults</button>
              </div>
            </section>
          </section>

          <aside class="pane">
            <h2>Implemented Products</h2>
            <table class="table" aria-label="Implemented products">
              <thead>
                <tr>
                  <th>Project</th>
                  <th>Released</th>
                </tr>
              </thead>
              <tbody id="project-table-body">
                <tr>
                  <td colspan="2">Loading projects...</td>
                </tr>
              </tbody>
            </table>
          </aside>
        </section>

      </section>
    </main>

    <script>
      const fallbackProjects = [
        { name: "QR Code Machine", url: "https://qrcodemachine.vercel.app", releasedYear: 2025 },
        { name: "Product Shot", url: "https://productshot.vercel.app", releasedYear: 2025 },
        { name: "Personal Software Request", url: "https://personal-software-request.vercel.app", releasedYear: 2026 }
      ];

      function renderProjects(projects) {
        const body = document.getElementById("project-table-body");
        body.innerHTML = "";

        projects.forEach((project) => {
          const row = document.createElement("tr");
          const safeUrl = project.url && project.url !== "#" ? project.url : null;
          row.innerHTML = `
            <td>${safeUrl ? `<a href="${safeUrl}" target="_blank" rel="noreferrer">${project.name}</a>` : project.name}</td>
            <td>${project.releasedYear || "-"}</td>
          `;
          body.appendChild(row);
        });
      }

      async function loadProjects() {
        try {
          const response = await fetch("/projects.json");
          if (!response.ok) throw new Error("Project list unavailable");
          const data = await response.json();
          if (!Array.isArray(data.projects) || !data.projects.length) throw new Error("No projects");
          renderProjects(data.projects);
        } catch (error) {
          renderProjects(fallbackProjects);
        }
      }

      loadProjects();

      const form = document.getElementById("request-form");
      const statusEl = document.getElementById("status");
      const submitBtn = document.getElementById("submit-btn");
      const sheetEl = document.querySelector(".sheet");
      const MATRIX_CHARS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%&*+=-";
      let testTriggerOnSubmit = true;
      let isWaveRunning = false;
      const controlSweep = document.getElementById("ctrl-sweep");
      const controlSpin = document.getElementById("ctrl-spin");
      const controlStagger = document.getElementById("ctrl-stagger");
      const controlTick = document.getElementById("ctrl-tick");
      const controlSubmitTrigger = document.getElementById("ctrl-submit-trigger");
      const runWaveTestBtn = document.getElementById("run-wave-test-btn");
      const resetWaveBtn = document.getElementById("reset-wave-btn");

      const defaultWaveConfig = {
        nodeSweepMs: 1000,
        spinMs: 2000,
        charStaggerMs: 80,
        tickMs: 20
      };

      function clamp(value, min, max) {
        return Math.min(max, Math.max(min, value));
      }

      function currentWaveConfig() {
        return {
          nodeSweepMs: clamp(Number(controlSweep.value) || defaultWaveConfig.nodeSweepMs, 200, 15000),
          spinMs: clamp(Number(controlSpin.value) || defaultWaveConfig.spinMs, 200, 15000),
          charStaggerMs: clamp(Number(controlStagger.value) || defaultWaveConfig.charStaggerMs, 1, 500),
          tickMs: clamp(Number(controlTick.value) || defaultWaveConfig.tickMs, 16, 500)
        };
      }

      function applyControlConfig(config) {
        controlSweep.value = String(config.nodeSweepMs);
        controlSpin.value = String(config.spinMs);
        controlStagger.value = String(config.charStaggerMs);
        controlTick.value = String(config.tickMs);
      }

      applyControlConfig(defaultWaveConfig);

      function randomMatrixChar() {
        return MATRIX_CHARS[Math.floor(Math.random() * MATRIX_CHARS.length)];
      }

      function scrambleText(value) {
        return value
          .split("")
          .map((char) => {
            if (char === " " || char === "\n" || char === "\t") return char;
            return randomMatrixChar();
          })
          .join("");
      }

      function runMatrixWave(root, config = currentWaveConfig()) {
        if (!root || isWaveRunning) return Promise.resolve();
        isWaveRunning = true;

        const walker = document.createTreeWalker(
          root,
          NodeFilter.SHOW_TEXT,
          {
            acceptNode(node) {
              if (!node.nodeValue || !node.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
              const parentTag = node.parentElement?.tagName;
              if (!parentTag) return NodeFilter.FILTER_REJECT;
              if (["SCRIPT", "STYLE", "TEXTAREA", "INPUT"].includes(parentTag)) {
                return NodeFilter.FILTER_REJECT;
              }
              return NodeFilter.FILTER_ACCEPT;
            }
          }
        );

        const nodes = [];
        while (walker.nextNode()) {
          const textNode = walker.currentNode;
          const range = document.createRange();
          range.selectNodeContents(textNode);
          const top = range.getBoundingClientRect().top || 0;
          nodes.push({ node: textNode, original: textNode.nodeValue, top });
        }

        if (!nodes.length) {
          isWaveRunning = false;
          return Promise.resolve();
        }

        nodes.sort((a, b) => a.top - b.top);
        const minTop = nodes[0].top;
        const maxTop = nodes[nodes.length - 1].top;
        const span = Math.max(maxTop - minTop, 1);

        const { nodeSweepMs, charStaggerMs, spinMs, tickMs } = config;
        const plans = [];
        let totalDuration = 0;

        nodes.forEach((entry, nodeIndex) => {
          const chars = entry.original.split("");
          const mutableIndices = [];

          chars.forEach((char, index) => {
            if (char !== " " && char !== "\n" && char !== "\t") mutableIndices.push(index);
          });

          const nodeWeight = (entry.top - minTop) / span;
          const nodeStart = Math.floor(nodeWeight * nodeSweepMs);

          const schedule = mutableIndices.map((charIndex, order) => {
            const startAt = nodeStart + order * charStaggerMs;
            const endAt = startAt + spinMs;
            if (endAt > totalDuration) totalDuration = endAt;
            return { charIndex, startAt, endAt };
          });

          plans.push({ node: entry.node, original: chars, schedule, nodeIndex });
        });

        const animationStart = performance.now();
        let lastTick = -1;

        function frame(now) {
          const elapsed = now - animationStart;
          const tick = Math.floor(elapsed / tickMs);

          if (tick !== lastTick) {
            plans.forEach((plan) => {
              const next = plan.original.slice();

              plan.schedule.forEach((charPlan, planIndex) => {
                if (elapsed >= charPlan.startAt && elapsed < charPlan.endAt) {
                  const seed = tick * 17 + plan.nodeIndex * 31 + planIndex * 13;
                  next[charPlan.charIndex] = MATRIX_CHARS[seed % MATRIX_CHARS.length];
                }
              });

              plan.node.nodeValue = next.join("");
            });

            lastTick = tick;
          }

          if (elapsed < totalDuration) {
            requestAnimationFrame(frame);
            return;
          }

          plans.forEach((plan) => {
            plan.node.nodeValue = plan.original.join("");
          });
          isWaveRunning = false;
        }

        requestAnimationFrame(frame);

        return new Promise((resolve) => {
          window.setTimeout(resolve, totalDuration + 24);
        });
      }

      controlSubmitTrigger.addEventListener("change", () => {
        testTriggerOnSubmit = controlSubmitTrigger.checked;
      });

      runWaveTestBtn.addEventListener("click", () => {
        runMatrixWave(sheetEl);
      });

      resetWaveBtn.addEventListener("click", () => {
        applyControlConfig(defaultWaveConfig);
        controlSubmitTrigger.checked = true;
        testTriggerOnSubmit = true;
      });

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (testTriggerOnSubmit) {
          runMatrixWave(sheetEl);
        }
        statusEl.className = "status";
        statusEl.textContent = "Sending...";
        submitBtn.disabled = true;

        const payload = {
          memo: form.memo.value.trim(),
          email: form.email.value.trim()
        };

        try {
          const response = await fetch("/api/submit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const data = await response.json().catch(() => ({}));
          if (!response.ok) throw new Error(data.error || "Request failed");

          form.reset();
          statusEl.className = "status ok";
          statusEl.textContent = "Submitted.";
        } catch (error) {
          statusEl.className = "status err";
          statusEl.textContent = error.message || "Could not submit.";
        } finally {
          submitBtn.disabled = false;
        }
      });
    </script>
  </body>
</html>
